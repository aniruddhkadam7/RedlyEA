# GitHub Actions workflow for building and publishing RedlyEA Electron app
# Triggers on version tags (v1.0.0, v1.0.1, etc.)
# Builds Windows .exe and uploads to GitHub Releases
#
# How it works:
# 1. You create a tag (git tag v1.0.0) and push it, OR create a release via GitHub UI
# 2. GitHub Actions detects the tag and runs this workflow
# 3. The workflow builds the .exe files on a Windows runner
# 4. The .exe files are uploaded to the GitHub Release page
# 5. Source code (zip/tar.gz) always appears - that's GitHub's default, not from this workflow
#
# The source code archives CANNOT be removed - GitHub adds them automatically.
# Your .exe files will appear ALONGSIDE them under Assets.

name: Release Desktop App

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: pnpm run build
        env:
          CI: true
          NODE_ENV: production
          ELECTRON_BUILD: "1"

      - name: Validate build output
        run: pnpm run validate:build

      - name: Generate icons
        run: pnpm run desktop:icons
        continue-on-error: true

      - name: Ensure build icons directory exists
        shell: pwsh
        run: |
          # Ensure build/icons directory exists with at least a fallback icon
          if (-not (Test-Path "build/icons")) {
            New-Item -ItemType Directory -Path "build/icons" -Force | Out-Null
            Write-Host "Created build/icons directory"
          }
          # Always ensure icon.png exists (electron-builder can use it)
          if (-not (Test-Path "build/icons/icon.png")) {
            if (Test-Path "public/icons/icon-512x512.png") {
              Copy-Item "public/icons/icon-512x512.png" "build/icons/icon.png" -Force
              Copy-Item "public/icons/icon-512x512.png" "build/icons/eapkg-icon.png" -Force
              Write-Host "Copied PNG fallbacks to build/icons/"
            }
          }
          # If icon.ico was not generated, create one by wrapping the PNG in an ICO container
          if (-not (Test-Path "build/icons/icon.ico")) {
            Write-Host "icon.ico not found â€” generating from PNG via Node.js..."
            node -e @"
              const fs = require('fs');
              const png = fs.readFileSync('public/icons/icon-512x512.png');
              const w = png.readUInt32BE(16), h = png.readUInt32BE(20);
              const sz = Math.min(Math.max(w,1),256); const ico_sz = sz>=256?0:sz;
              const hdr=6, ent=16, off=hdr+ent, buf=Buffer.alloc(off+png.length);
              let o=0;
              buf.writeUInt16LE(0,o); o+=2; buf.writeUInt16LE(1,o); o+=2; buf.writeUInt16LE(1,o); o+=2;
              buf.writeUInt8(ico_sz,o); o+=1; buf.writeUInt8(ico_sz,o); o+=1;
              buf.writeUInt8(0,o); o+=1; buf.writeUInt8(0,o); o+=1;
              buf.writeUInt16LE(1,o); o+=2; buf.writeUInt16LE(32,o); o+=2;
              buf.writeUInt32LE(png.length,o); o+=4; buf.writeUInt32LE(off,o);
              png.copy(buf, off);
              fs.writeFileSync('build/icons/icon.ico', buf);
              fs.writeFileSync('build/icons/eapkg-icon.ico', buf);
              console.log('Generated icon.ico and eapkg-icon.ico from PNG');
          "@
          }
          Write-Host "Icons directory contents:"
          Get-ChildItem -Path "build/icons" -ErrorAction SilentlyContinue

      - name: Build Windows installer and portable exe
        shell: pwsh
        run: |
          Write-Host "Building Windows executables..." -ForegroundColor Green
          npx electron-builder --config electron-builder.json --win --publish always
          Write-Host "electron-builder finished with exit code: $LASTEXITCODE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List build output
        shell: pwsh
        run: |
          Write-Host "=== All files in release/ ===" -ForegroundColor Green
          Get-ChildItem -Path release -Recurse -ErrorAction SilentlyContinue | Format-Table Name, Length -AutoSize

      - name: Verify .exe files exist
        shell: pwsh
        run: |
          $exeFiles = Get-ChildItem -Path release -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue
          if ($exeFiles.Count -eq 0) {
            Write-Host "ERROR: No .exe files found in release/ directory!" -ForegroundColor Red
            Write-Host "Build likely failed. Check the 'Build Windows installer' step above for errors." -ForegroundColor Red
            exit 1
          }
          Write-Host "SUCCESS: Found $($exeFiles.Count) .exe file(s):" -ForegroundColor Green
          $exeFiles | ForEach-Object { Write-Host "  $($_.Name) ($([math]::Round($_.Length / 1MB, 1)) MB)" }

      - name: Upload .exe to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*.exe
          fail_on_unmatched_files: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
