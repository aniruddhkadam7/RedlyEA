# GitHub Actions workflow for building RedlyEA Electron app on main branch
# Triggers on push to main branch
# Builds Windows .exe installer and portable executables

name: Build Desktop App (Main Branch)

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Limit concurrent builds
concurrency:
  group: build-desktop-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web assets
        run: pnpm run build
        env:
          NODE_ENV: production
          ELECTRON_BUILD: "1"

      - name: Validate build output
        run: pnpm run validate:build

      - name: Generate icons
        run: pnpm run desktop:icons
        continue-on-error: true

      - name: Ensure build icons exist
        shell: pwsh
        run: |
          if (-not (Test-Path "build/icons")) {
            New-Item -ItemType Directory -Path "build/icons" -Force | Out-Null
          }
          if (-not (Test-Path "build/icons/icon.png")) {
            if (Test-Path "public/icons/icon-512x512.png") {
              Copy-Item "public/icons/icon-512x512.png" "build/icons/icon.png" -Force
              Copy-Item "public/icons/icon-512x512.png" "build/icons/eapkg-icon.png" -Force
            }
          }
          if (-not (Test-Path "build/icons/icon.ico")) {
            node -e @"
              const fs = require('fs');
              const png = fs.readFileSync('public/icons/icon-512x512.png');
              const w = png.readUInt32BE(16), h = png.readUInt32BE(20);
              const sz = Math.min(Math.max(w,1),256); const ico_sz = sz>=256?0:sz;
              const hdr=6, ent=16, off=hdr+ent, buf=Buffer.alloc(off+png.length);
              let o=0;
              buf.writeUInt16LE(0,o); o+=2; buf.writeUInt16LE(1,o); o+=2; buf.writeUInt16LE(1,o); o+=2;
              buf.writeUInt8(ico_sz,o); o+=1; buf.writeUInt8(ico_sz,o); o+=1;
              buf.writeUInt8(0,o); o+=1; buf.writeUInt8(0,o); o+=1;
              buf.writeUInt16LE(1,o); o+=2; buf.writeUInt16LE(32,o); o+=2;
              buf.writeUInt32LE(png.length,o); o+=4; buf.writeUInt32LE(off,o);
              png.copy(buf, off);
              fs.writeFileSync('build/icons/icon.ico', buf);
              fs.writeFileSync('build/icons/eapkg-icon.ico', buf);
              console.log('Generated ICO fallback from PNG');
          "@
          }
          Get-ChildItem -Path "build/icons" -ErrorAction SilentlyContinue

      - name: Build Windows installer and portable exe
        shell: pwsh
        run: |
          npx electron-builder --config electron-builder.json --win --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check build artifacts
        run: |
          echo "Checking for build artifacts in release/ directory..."
          Get-ChildItem -Path release -Recurse -ErrorAction SilentlyContinue | Format-Table -AutoSize
        shell: powershell

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            release/*.exe
            release/*.yml
            release/*.blockmap
          retention-days: 30
          if-no-files-found: warn
